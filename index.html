<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Busamed Bloemfontein CareFlow Portal</title>
  <style>
    :root {
      --bg: #f3f7fd;
      --card: #fff;
      --line: #d5e2f5;
      --text: #1f2937;
      --muted: #667085;
      --primary: #1258c3;
      --primary-2: #0f4595;
      --ok-bg: #ecfdf3;
      --ok: #05603a;
      --warn-bg: #fff7e8;
      --warn: #92400e;
      --danger-bg: #fee2e2;
      --danger: #991b1b;
      --critical: #b91c1c;
      --high: #ea580c;
      --medium: #ca8a04;
      --low: #15803d;
    }

    * { box-sizing: border-box; font-family: Inter, Segoe UI, Arial, sans-serif; }
    body { margin: 0; color: var(--text); background: var(--bg); }
    header {
      background: linear-gradient(120deg, #0e3978, #1258c3);
      color: white;
      padding: 1rem 1.2rem;
      position: sticky;
      top: 0;
      z-index: 5;
    }
    h1 { margin: 0; font-size: 1.25rem; }
    header p { margin: .32rem 0 0; opacity: .92; }

    .layout {
      display: grid;
      grid-template-columns: 360px 1fr;
      gap: 1rem;
      align-items: start;
      padding: 1rem;
    }

    .panel, .card {
      background: var(--card);
      border: 1px solid var(--line);
      border-radius: 14px;
      padding: .95rem;
      box-shadow: 0 4px 16px rgba(15, 23, 42, .06);
    }

    .stack { display: grid; gap: .8rem; }
    .row { display: flex; gap: .6rem; flex-wrap: wrap; align-items: center; }

    label { display: block; font-size: .86rem; margin: .5rem 0 .23rem; font-weight: 600; }
    input, select, textarea, button {
      width: 100%; border-radius: 9px; border: 1px solid var(--line);
      padding: .55rem; font-size: .91rem;
    }
    textarea { min-height: 80px; resize: vertical; }

    button { background: var(--primary); color: #fff; font-weight: 700; border: none; cursor: pointer; }
    button:hover { background: var(--primary-2); }
    .btn-secondary { background: #eef4ff; color: #214c9b; border: 1px solid #c5d7f8; }

    .tabs { display: grid; gap: .45rem; }
    .tabs .active { background: var(--primary-2); }

    .kpis {
      display: grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap: .6rem;
    }
    .kpi {
      background: #f8fbff;
      border: 1px solid var(--line);
      border-radius: 10px;
      padding: .62rem;
    }
    .kpi small { color: var(--muted); display: block; }
    .kpi strong { color: #114cae; font-size: 1.2rem; }

    .grid2 { display: grid; gap: .85rem; grid-template-columns: repeat(auto-fit, minmax(320px, 1fr)); }

    table { width: 100%; border-collapse: collapse; font-size: .88rem; margin-top: .4rem; }
    th, td { text-align: left; border-bottom: 1px solid var(--line); padding: .45rem; vertical-align: top; }

    .msg { display: none; border-radius: 8px; padding: .5rem; margin-top: .6rem; font-size: .9rem; }
    .ok { background: var(--ok-bg); color: var(--ok); border: 1px solid #bde8cb; }
    .warn { background: var(--warn-bg); color: var(--warn); border: 1px solid #f0d6ad; }
    .danger { background: var(--danger-bg); color: var(--danger); border: 1px solid #f2b8b8; }

    .badge {
      display: inline-block;
      border-radius: 999px;
      padding: .17rem .53rem;
      color: #fff;
      font-size: .74rem;
      font-weight: 700;
    }
    .critical { background: var(--critical); }
    .high { background: var(--high); }
    .medium { background: var(--medium); }
    .low { background: var(--low); }

    .muted { color: var(--muted); font-size: .85rem; }
    .session-box {
      border: 1px dashed #c2d4f6;
      border-radius: 10px;
      background: #f8fbff;
      padding: .6rem;
      font-size: .86rem;
    }

    @media (max-width: 980px) {
      .layout { grid-template-columns: 1fr; }
      .kpis { grid-template-columns: 1fr 1fr; }
    }
  </style>
</head>
<body>
  <header>
    <div class="row" style="justify-content: space-between;">
      <div>
        <h1>Busamed Bloemfontein CareFlow Portal</h1>
        <p>Digital casualty, admission, ward nursing, and virtual follow-up workflows for modern paperless care.</p>
      </div>
      <div id="clock" class="muted" style="color:#e2edff;"></div>
    </div>
  </header>

  <main class="layout">
    <aside class="panel stack">
      <section>
        <h2 style="margin:0 0 .55rem;">Secure Login (Demo)</h2>
        <div class="session-box">
          <div><strong>Admin</strong>: admin@busamed.demo / Admin@123</div>
          <div><strong>Casualty Doctor</strong>: doctor@busamed.demo / Doctor@123</div>
          <div><strong>Ward Nurse</strong>: nurse@busamed.demo / Nurse@123</div>
          <div><strong>Patient</strong>: patient@busamed.demo / Patient@123</div>
          <div><strong>OTP</strong>: 123456</div>
        </div>
        <label>Email</label>
        <input id="email" type="email" placeholder="user@busamed.demo" />
        <label>Password</label>
        <input id="password" type="password" />
        <label>One-time code</label>
        <input id="otp" placeholder="6-digit code" />
        <button id="loginBtn" style="margin-top:.6rem;">Login</button>
        <button id="logoutBtn" class="btn-secondary" style="margin-top:.45rem;">Logout</button>
        <div id="loginMsg" class="msg"></div>
      </section>

      <section>
        <h2 style="margin:0 0 .55rem;">Role Tabs</h2>
        <div id="tabs" class="tabs"></div>
      </section>

      <section class="session-box">
        <div><strong>Session:</strong> <span id="sessionText">Not logged in</span></div>
        <div class="muted">Works on desktop/laptop and tablets, with in-browser cloud-like persistence for demo.</div>
      </section>
    </aside>

    <section id="content" class="stack"></section>
  </main>

  <script>
    const KEY = 'busamed-careflow-v5';

    const users = {
      'admin@busamed.demo': { password: 'Admin@123', role: 'admin', fullName: 'N. Maseko (Admissions)' },
      'doctor@busamed.demo': { password: 'Doctor@123', role: 'doctor', fullName: 'Dr. L. Mokoena (Casualty)' },
      'nurse@busamed.demo': { password: 'Nurse@123', role: 'nurse', fullName: 'P. Dube (Ward Nurse)' },
      'patient@busamed.demo': { password: 'Patient@123', role: 'patient', fullName: 'T. Molefe (Patient)' }
    };

    const tabsByRole = {
      admin: [
        { id: 'adminDashboard', label: 'Admissions Dashboard' },
        { id: 'openFile', label: 'Open Patient File' },
        { id: 'assignCasualty', label: 'Assign Casualty Doctor' },
        { id: 'admissionsDesk', label: 'Admit / Discharge Desk' },
        { id: 'outbox', label: 'Notification Outbox' }
      ],
      doctor: [
        { id: 'doctorDashboard', label: 'Casualty Queue' },
        { id: 'doctorAssessment', label: 'Casualty Assessment Form' },
        { id: 'doctorDecision', label: 'Home vs Admit Decision' },
        { id: 'doctorDocs', label: 'Medical Documents' },
        { id: 'outbox', label: 'Notification Outbox' }
      ],
      nurse: [
        { id: 'nurseDashboard', label: 'Ward Dashboard' },
        { id: 'wardIntake', label: 'Ward Intake Form' },
        { id: 'vitalsIssues', label: 'Vitals and Issues Log' },
        { id: 'medAdmin', label: 'Medication Checklist' },
        { id: 'outbox', label: 'Notification Outbox' }
      ],
      patient: [
        { id: 'patientHome', label: 'My Discharge Summary' },
        { id: 'patientTicket', label: 'Log Post-Discharge Ticket' }
      ]
    };

    const seed = {
      auth: { loggedIn: false, email: '', role: '', name: '', lastLogin: '' },
      doctors: [
        { id: 'd1', name: 'Dr. L. Mokoena', ward: 'Casualty', email: 'doctor@busamed.demo' },
        { id: 'd2', name: 'Dr. K. Naidoo', ward: 'Surgical', email: 'dr.naidoo@busamed.demo' }
      ],
      nurses: [
        { id: 'n1', name: 'Nurse P. Dube', ward: 'Surgical', email: 'nurse@busamed.demo' },
        { id: 'n2', name: 'Nurse A. Jacobs', ward: 'ICU', email: 'nurse.icu@busamed.demo' }
      ],
      patients: [
        {
          id: 'p1', fullName: 'Thabo Molefe', idNumber: '8501015009088', phone: '0820001111', email: 'patient@busamed.demo',
          address: '12 Nelson Street, Bloemfontein', medicalAidScheme: 'Discovery Health', medicalAidNumber: 'DH8391022',
          emergencyContact: 'Lerato Molefe - 0829990000', nextOfKin: 'Lerato Molefe',
          presentingComplaint: 'Chest discomfort and dizziness', triageCategory: 'high',
          casualtyDoctorId: 'd1', ward: 'Surgical', admitted: true, status: 'admitted',
          diagnosis: 'Hypertension with monitoring required',
          prescriptions: [
            { id: 'rx1', medication: 'Amlodipine 5mg', instruction: '1 tablet after breakfast', schedule: '08:00', createdAt: '2026-02-17 09:20' }
          ],
          assessments: [],
          nurseIntake: null,
          vitals: [],
          issues: [],
          docs: [],
          medLogs: [],
          discharge: null
        }
      ],
      tickets: [],
      emails: [
        { id: 'e1', to: 'doctor@busamed.demo', type: 'Assignment', subject: 'Assigned casualty patient: Thabo Molefe', sentAt: '2026-02-17 08:10' }
      ]
    };

    let state = load();
    let activeTab = state.auth.loggedIn ? tabsByRole[state.auth.role][0].id : '';

    const tabsEl = document.getElementById('tabs');
    const contentEl = document.getElementById('content');
    const sessionText = document.getElementById('sessionText');
    const loginMsg = document.getElementById('loginMsg');

    function load() {
      try {
        const raw = localStorage.getItem(KEY);
        return raw ? JSON.parse(raw) : structuredClone(seed);
      } catch {
        return structuredClone(seed);
      }
    }
    function save() { localStorage.setItem(KEY, JSON.stringify(state)); }
    function now() { return new Date().toLocaleString(); }

    function queueEmail(to, type, subject) {
      state.emails.unshift({ id: 'e' + Date.now(), to, type, subject, sentAt: now() });
    }

    function badge(level) {
      const c = level || 'low';
      return `<span class="badge ${c}">${c.toUpperCase()}</span>`;
    }

    function setMsg(el, kind, txt) {
      el.className = `msg ${kind}`;
      el.style.display = 'block';
      el.textContent = txt;
    }

    function patientOptions(filter = null) {
      const list = filter ? state.patients.filter(filter) : state.patients;
      return list.map(p => `<option value="${p.id}">${p.fullName} - ${p.ward || 'No ward'} - ${p.status}</option>`).join('');
    }

    function doctorName(id) { return state.doctors.find(d => d.id === id)?.name || 'Unassigned'; }

    function signIn() {
      const email = document.getElementById('email').value.trim().toLowerCase();
      const password = document.getElementById('password').value;
      const otp = document.getElementById('otp').value.trim();
      const u = users[email];

      if (!u || u.password !== password || otp !== '123456') {
        setMsg(loginMsg, 'danger', 'Login failed. Check email/password and OTP 123456.');
        return;
      }

      state.auth = { loggedIn: true, email, role: u.role, name: u.fullName, lastLogin: now() };
      activeTab = tabsByRole[u.role][0].id;
      save();
      setMsg(loginMsg, 'ok', `Welcome ${u.fullName}. Your secure session has started.`);
      render();
    }

    function signOut() {
      state.auth = { loggedIn: false, email: '', role: '', name: '', lastLogin: '' };
      activeTab = '';
      save();
      setMsg(loginMsg, 'warn', 'Signed out.');
      render();
    }

    function renderTabs() {
      tabsEl.innerHTML = '';
      if (!state.auth.loggedIn) return;
      tabsByRole[state.auth.role].forEach(t => {
        const b = document.createElement('button');
        b.textContent = t.label;
        b.className = activeTab === t.id ? 'active' : 'btn-secondary';
        b.onclick = () => { activeTab = t.id; renderTabs(); renderContent(); };
        tabsEl.appendChild(b);
      });
    }

    function renderAuthLocked() {
      return `<article class="card"><h2>Please login</h2><p class="muted">Use dummy credentials to view the role-specific professional portal.</p></article>`;
    }

    function renderAdminDashboard() {
      const admitted = state.patients.filter(p => p.status === 'admitted').length;
      const discharged = state.patients.filter(p => p.status === 'discharged').length;
      return `
      <article class="card">
        <h2>Admissions Dashboard</h2>
        <div class="kpis">
          <div class="kpi"><small>Total files</small><strong>${state.patients.length}</strong></div>
          <div class="kpi"><small>Admitted</small><strong>${admitted}</strong></div>
          <div class="kpi"><small>Discharged</small><strong>${discharged}</strong></div>
          <div class="kpi"><small>Notifications</small><strong>${state.emails.length}</strong></div>
        </div>
      </article>
      <article class="card">
        <h3>Casualty / Admission Board</h3>
        <table>
          <thead><tr><th>Patient</th><th>Triage</th><th>Status</th><th>Doctor</th><th>Ward</th><th>Medical Aid</th></tr></thead>
          <tbody>${state.patients.map(p => `<tr><td>${p.fullName}</td><td>${badge(p.triageCategory)}</td><td>${p.status}</td><td>${doctorName(p.casualtyDoctorId)}</td><td>${p.ward || '-'}</td><td>${p.medicalAidScheme || '-'}</td></tr>`).join('')}</tbody>
        </table>
      </article>`;
    }

    function renderOpenFile() {
      return `
      <article class="card">
        <h2>Open New Patient File (Casualty)</h2>
        <form id="openFileForm">
          <div class="grid2">
            <div>
              <label>Full Name</label><input required name="fullName" />
              <label>ID Number</label><input required name="idNumber" />
              <label>Email</label><input required type="email" name="email" />
              <label>Phone</label><input required name="phone" />
              <label>Residential Address</label><textarea required name="address"></textarea>
              <label>Emergency Contact</label><input required name="emergencyContact" />
            </div>
            <div>
              <label>Medical Aid Scheme</label><input required name="medicalAidScheme" />
              <label>Medical Aid Number</label><input required name="medicalAidNumber" />
              <label>Next of Kin</label><input required name="nextOfKin" />
              <label>Presenting Complaint (Casualty)</label><textarea required name="presentingComplaint"></textarea>
              <label>Triage Priority</label><select required name="triageCategory"><option value="low">Low</option><option value="medium">Medium</option><option value="high">High</option><option value="critical">Critical</option></select>
              <label>Consent Signature</label><input required name="signature" placeholder="Patient full name" />
            </div>
          </div>
          <button type="submit">Open File</button>
          <div id="openFileMsg" class="msg ok"></div>
        </form>
      </article>`;
    }

    function renderAssignCasualty() {
      return `
      <article class="card">
        <h2>Assign Casualty Doctor</h2>
        <form id="assignForm">
          <label>Patient</label><select required name="patientId">${patientOptions(p => p.status !== 'discharged')}</select>
          <label>Casualty Doctor</label><select required name="doctorId">${state.doctors.map(d => `<option value="${d.id}">${d.name} (${d.email})</option>`).join('')}</select>
          <button type="submit">Assign Doctor + Notify</button>
          <div id="assignMsg" class="msg ok"></div>
        </form>
      </article>`;
    }

    function renderAdmissionsDesk() {
      const admitted = state.patients.filter(p => p.status === 'admitted');
      return `
      <article class="card">
        <h2>Admissions / Discharge Desk</h2>
        <form id="dischargeForm">
          <label>Discharge Patient</label><select required name="patientId">${admitted.length ? patientOptions(p => p.status === 'admitted') : '<option value="">No admitted patients</option>'}</select>
          <label>Discharge Summary</label><textarea required name="summary"></textarea>
          <label>Patient Rating</label><select required name="rating"><option>5</option><option>4</option><option>3</option><option>2</option><option>1</option></select>
          <label>Feedback</label><textarea required name="feedback"></textarea>
          <button type="submit">Discharge + Close Admission</button>
          <div id="dischargeMsg" class="msg ok"></div>
        </form>
      </article>`;
    }

    function renderDoctorDashboard() {
      const queue = state.patients.filter(p => p.status === 'casualty' || p.status === 'admitted');
      return `
      <article class="card">
        <h2>Casualty Doctor Queue</h2>
        <table>
          <thead><tr><th>Patient</th><th>Triage</th><th>Complaint</th><th>Status</th><th>Doctor</th></tr></thead>
          <tbody>${queue.map(p => `<tr><td>${p.fullName}</td><td>${badge(p.triageCategory)}</td><td>${p.presentingComplaint}</td><td>${p.status}</td><td>${doctorName(p.casualtyDoctorId)}</td></tr>`).join('')}</tbody>
        </table>
      </article>`;
    }

    function renderDoctorAssessment() {
      return `
      <article class="card">
        <h2>Casualty Clinical Assessment Form</h2>
        <form id="assessmentForm">
          <label>Patient</label><select required name="patientId">${patientOptions(p => p.status !== 'discharged')}</select>
          <label>Assessment Date/Time</label><input required type="datetime-local" name="time" />
          <label>Clinical Notes</label><textarea required name="notes"></textarea>
          <label>Working Diagnosis</label><textarea required name="diagnosis"></textarea>
          <label>Risk/Criticality Update</label><select required name="triageCategory"><option value="low">Low</option><option value="medium">Medium</option><option value="high">High</option><option value="critical">Critical</option></select>
          <button type="submit">Save Assessment</button>
          <div id="assessmentMsg" class="msg ok"></div>
        </form>
      </article>`;
    }

    function renderDoctorDecision() {
      return `
      <article class="card">
        <h2>Doctor Disposition Decision Form</h2>
        <form id="decisionForm">
          <label>Patient</label><select required name="patientId">${patientOptions(p => p.status !== 'discharged')}</select>
          <label>Decision</label><select required name="decision"><option value="home">Treat and Send Home</option><option value="admit">Admit to Ward</option></select>
          <label>Medication</label><input required name="medication" placeholder="e.g. Augmentin 625mg" />
          <label>Medication Instruction</label><textarea required name="instruction"></textarea>
          <label>Take At Time</label><input required type="time" name="schedule" />
          <label>If admitted, ward</label><select name="ward"><option>Surgical</option><option>ICU</option><option>Maternity</option><option>Medical</option></select>
          <button type="submit">Save Decision + Notify Team</button>
          <div id="decisionMsg" class="msg ok"></div>
        </form>
      </article>`;
    }

    function renderDoctorDocs() {
      return `
      <article class="card">
        <h2>Upload Clinical Documents (PDF only, max 10)</h2>
        <form id="docForm">
          <label>Patient</label><select required name="patientId">${patientOptions(p => p.status !== 'discharged')}</select>
          <label>Document Title</label><input required name="title" />
          <label>Upload PDF</label><input required type="file" name="file" accept="application/pdf,.pdf" />
          <button type="submit">Upload File</button>
          <div id="docMsg" class="msg"></div>
        </form>
      </article>`;
    }

    function renderNurseDashboard() {
      const wardPatients = state.patients.filter(p => p.status === 'admitted');
      return `
      <article class="card">
        <h2>Ward Nursing Dashboard</h2>
        <table>
          <thead><tr><th>Patient</th><th>Ward</th><th>Triage</th><th>Vitals Logs</th><th>Issues</th><th>Med Logs</th></tr></thead>
          <tbody>${wardPatients.map(p => `<tr><td>${p.fullName}</td><td>${p.ward || '-'}</td><td>${badge(p.triageCategory)}</td><td>${p.vitals.length}</td><td>${p.issues.length}</td><td>${p.medLogs.length}</td></tr>`).join('')}</tbody>
        </table>
      </article>`;
    }

    function renderWardIntake() {
      return `
      <article class="card">
        <h2>Ward Intake Nursing Form</h2>
        <form id="wardIntakeForm">
          <label>Admitted Patient</label><select required name="patientId">${patientOptions(p => p.status === 'admitted')}</select>
          <label>Intake Date/Time</label><input required type="datetime-local" name="time" />
          <label>Initial Observations</label><textarea required name="observations"></textarea>
          <label>Nursing Care Plan</label><textarea required name="carePlan"></textarea>
          <button type="submit">Save Ward Intake</button>
          <div id="wardIntakeMsg" class="msg ok"></div>
        </form>
      </article>`;
    }

    function renderVitalsIssues() {
      return `
      <article class="card">
        <h2>Vitals and Patient Issues Log</h2>
        <form id="vitalsForm">
          <label>Patient</label><select required name="patientId">${patientOptions(p => p.status === 'admitted')}</select>
          <label>Date/Time</label><input required type="datetime-local" name="time" />
          <label>Blood Pressure</label><input required name="bp" placeholder="e.g. 145/95" />
          <label>Pulse / Temp / Notes</label><textarea required name="notes"></textarea>
          <label>Patient Issue (optional)</label><textarea name="issue" placeholder="Pain, nausea, bleeding, etc"></textarea>
          <button type="submit">Save Log</button>
          <div id="vitalsMsg" class="msg ok"></div>
        </form>
      </article>`;
    }

    function renderMedAdmin() {
      return `
      <article class="card">
        <h2>Medication Administration Checklist</h2>
        <form id="medForm">
          <label>Patient</label><select required id="medPatient" name="patientId">${patientOptions(p => p.status === 'admitted')}</select>
          <div id="medRows" class="stack" style="margin-top:.5rem;"></div>
          <button type="submit">Save Medication Tick</button>
          <div id="medMsg" class="msg ok"></div>
        </form>
      </article>`;
    }

    function renderPatientHome() {
      const p = state.patients.find(x => x.email === state.auth.email) || state.patients[0];
      return `
      <article class="card">
        <h2>Patient Virtual Follow-up</h2>
        <p><strong>Name:</strong> ${p.fullName}</p>
        <p><strong>Status:</strong> ${p.status}</p>
        <p><strong>Assigned Ward:</strong> ${p.ward || '-'}</p>
        <p><strong>Assigned Doctor:</strong> ${doctorName(p.casualtyDoctorId)}</p>
        <p><strong>Last Discharge Summary:</strong> ${p.discharge?.summary || 'Not discharged yet'}</p>
      </article>`;
    }

    function renderPatientTicket() {
      const discharged = state.patients.filter(p => p.status === 'discharged');
      return `
      <article class="card">
        <h2>Post-Discharge Ticket Form</h2>
        <form id="ticketForm">
          <label>Patient</label><select required name="patientId">${discharged.length ? patientOptions(p => p.status === 'discharged') : '<option value="">No discharged patients</option>'}</select>
          <label>Ward treated in</label><input required name="ward" placeholder="e.g. Surgical" />
          <label>Doctor treated by</label><select required name="doctorId">${state.doctors.map(d => `<option value="${d.id}">${d.name}</option>`).join('')}</select>
          <label>Issue Category</label><select required name="category"><option>Medication Query</option><option>Wound Concern</option><option>Pain Management</option><option>Billing/Admin</option></select>
          <label>Issue Details</label><textarea required name="details"></textarea>
          <button type="submit">Create Ticket</button>
          <div id="ticketMsg" class="msg ok"></div>
        </form>
      </article>`;
    }

    function renderOutbox() {
      return `
      <article class="card">
        <h2>Notification Outbox</h2>
        <table>
          <thead><tr><th>Time</th><th>To</th><th>Type</th><th>Subject</th></tr></thead>
          <tbody>${state.emails.length ? state.emails.map(e => `<tr><td>${e.sentAt}</td><td>${e.to}</td><td>${e.type}</td><td>${e.subject}</td></tr>`).join('') : '<tr><td colspan="4">No notifications</td></tr>'}</tbody>
        </table>
      </article>`;
    }

    function bindAdmin() {
      const openFileForm = document.getElementById('openFileForm');
      if (openFileForm) {
        openFileForm.onsubmit = (e) => {
          e.preventDefault();
          const d = new FormData(openFileForm);
          const p = {
            id: 'p' + Date.now(),
            fullName: d.get('fullName'), idNumber: d.get('idNumber'), email: d.get('email'), phone: d.get('phone'),
            address: d.get('address'), medicalAidScheme: d.get('medicalAidScheme'), medicalAidNumber: d.get('medicalAidNumber'),
            emergencyContact: d.get('emergencyContact'), nextOfKin: d.get('nextOfKin'),
            presentingComplaint: d.get('presentingComplaint'), triageCategory: d.get('triageCategory'),
            casualtyDoctorId: '', ward: 'Casualty', admitted: false, status: 'casualty', diagnosis: '',
            prescriptions: [], assessments: [], nurseIntake: null, vitals: [], issues: [], docs: [], medLogs: [], discharge: null
          };
          state.patients.push(p);
          save();
          setMsg(document.getElementById('openFileMsg'), 'ok', `${p.fullName} file opened successfully.`);
          openFileForm.reset();
          renderContent();
        };
      }

      const assignForm = document.getElementById('assignForm');
      if (assignForm) {
        assignForm.onsubmit = (e) => {
          e.preventDefault();
          const d = new FormData(assignForm);
          const p = state.patients.find(x => x.id === d.get('patientId'));
          const doc = state.doctors.find(x => x.id === d.get('doctorId'));
          if (!p || !doc) return;
          p.casualtyDoctorId = doc.id;
          queueEmail(doc.email, 'Doctor Assignment', `Assigned casualty case: ${p.fullName}`);
          save();
          setMsg(document.getElementById('assignMsg'), 'ok', `${doc.name} assigned and notified by email.`);
        };
      }

      const dischargeForm = document.getElementById('dischargeForm');
      if (dischargeForm) {
        dischargeForm.onsubmit = (e) => {
          e.preventDefault();
          const d = new FormData(dischargeForm);
          const p = state.patients.find(x => x.id === d.get('patientId'));
          if (!p) return;
          p.status = 'discharged';
          p.discharge = { time: now(), summary: d.get('summary'), rating: Number(d.get('rating')), feedback: d.get('feedback') };
          queueEmail(p.email, 'Discharge', `You have been discharged from Busamed. Rating captured: ${p.discharge.rating}/5`);
          save();
          setMsg(document.getElementById('dischargeMsg'), 'ok', `${p.fullName} discharged and feedback captured.`);
          renderContent();
        };
      }
    }

    function bindDoctor() {
      const assessmentForm = document.getElementById('assessmentForm');
      if (assessmentForm) {
        assessmentForm.onsubmit = (e) => {
          e.preventDefault();
          const d = new FormData(assessmentForm);
          const p = state.patients.find(x => x.id === d.get('patientId'));
          if (!p) return;
          p.assessments.unshift({ time: d.get('time'), notes: d.get('notes'), diagnosis: d.get('diagnosis'), doctor: state.auth.name });
          p.diagnosis = d.get('diagnosis');
          p.triageCategory = d.get('triageCategory');
          save();
          setMsg(document.getElementById('assessmentMsg'), 'ok', `Assessment saved for ${p.fullName}.`);
          assessmentForm.reset();
          renderContent();
        };
      }

      const decisionForm = document.getElementById('decisionForm');
      if (decisionForm) {
        decisionForm.onsubmit = (e) => {
          e.preventDefault();
          const d = new FormData(decisionForm);
          const p = state.patients.find(x => x.id === d.get('patientId'));
          if (!p) return;

          p.prescriptions.unshift({ id: 'rx' + Date.now(), medication: d.get('medication'), instruction: d.get('instruction'), schedule: d.get('schedule'), createdAt: now() });

          if (d.get('decision') === 'home') {
            p.status = 'discharged';
            p.ward = 'Home';
            p.discharge = { time: now(), summary: 'Casualty treatment completed. Sent home with medication.' };
            queueEmail(p.email, 'Casualty Outcome', `You were treated and sent home with medication plan.`);
          } else {
            p.status = 'admitted';
            p.admitted = true;
            p.ward = d.get('ward');
            const wardNurses = state.nurses.filter(n => n.ward.toLowerCase() === p.ward.toLowerCase());
            wardNurses.forEach(n => queueEmail(n.email, 'Ward Admission', `New admission in ${p.ward}: ${p.fullName}`));
            const assignedDoctor = state.doctors.find(doc => doc.id === p.casualtyDoctorId);
            if (assignedDoctor) {
              queueEmail(assignedDoctor.email, 'Admission File', `Patient file opened/admitted: ${p.fullName} (${p.ward})`);
            }
          }

          save();
          setMsg(document.getElementById('decisionMsg'), 'ok', `Doctor decision saved for ${p.fullName}.`);
          decisionForm.reset();
          renderContent();
        };
      }

      const docForm = document.getElementById('docForm');
      if (docForm) {
        docForm.onsubmit = (e) => {
          e.preventDefault();
          const d = new FormData(docForm);
          const p = state.patients.find(x => x.id === d.get('patientId'));
          const file = d.get('file');
          const msg = document.getElementById('docMsg');
          if (!p) return;

          if (p.docs.length >= 10) {
            setMsg(msg, 'warn', `Upload blocked: ${p.fullName} already has 10 files.`);
            return;
          }
          if (!file || !file.name || !file.name.toLowerCase().endsWith('.pdf')) {
            setMsg(msg, 'warn', 'Only PDF files allowed.');
            return;
          }

          p.docs.unshift({ title: d.get('title'), fileName: file.name, uploadedAt: now(), uploadedBy: state.auth.name });
          save();
          setMsg(msg, 'ok', `Document uploaded for ${p.fullName}. ${p.docs.length}/10 used.`);
          docForm.reset();
        };
      }
    }

    function paintMedRows(patientId) {
      const holder = document.getElementById('medRows');
      const p = state.patients.find(x => x.id === patientId);
      if (!holder || !p) return;
      if (!p.prescriptions.length) {
        holder.innerHTML = '<p class="muted">No prescriptions found for this patient.</p>';
        return;
      }

      holder.innerHTML = p.prescriptions.map((rx, i) => `
        <div class="panel">
          <div><strong>${rx.medication}</strong> ${badge(p.triageCategory)}</div>
          <div class="muted">Time: ${rx.schedule} | Instruction: ${rx.instruction}</div>
          <label>Given?</label>
          <select name="given_${i}"><option value="yes">Yes</option><option value="no">No</option></select>
          <label>Actual given date/time</label>
          <input type="datetime-local" name="time_${i}" />
          <input type="hidden" name="med_${i}" value="${rx.medication}" />
          <input type="hidden" name="ins_${i}" value="${rx.instruction}" />
          <input type="hidden" name="sch_${i}" value="${rx.schedule}" />
        </div>
      `).join('');
    }

    function bindNurse() {
      const wardIntakeForm = document.getElementById('wardIntakeForm');
      if (wardIntakeForm) {
        wardIntakeForm.onsubmit = (e) => {
          e.preventDefault();
          const d = new FormData(wardIntakeForm);
          const p = state.patients.find(x => x.id === d.get('patientId'));
          if (!p) return;
          p.nurseIntake = { time: d.get('time'), observations: d.get('observations'), carePlan: d.get('carePlan'), nurse: state.auth.name };
          save();
          setMsg(document.getElementById('wardIntakeMsg'), 'ok', `Ward intake saved for ${p.fullName}.`);
          wardIntakeForm.reset();
        };
      }

      const vitalsForm = document.getElementById('vitalsForm');
      if (vitalsForm) {
        vitalsForm.onsubmit = (e) => {
          e.preventDefault();
          const d = new FormData(vitalsForm);
          const p = state.patients.find(x => x.id === d.get('patientId'));
          if (!p) return;

          p.vitals.unshift({ time: d.get('time'), bloodPressure: d.get('bp'), notes: d.get('notes'), nurse: state.auth.name });
          const issue = d.get('issue')?.trim();
          if (issue) p.issues.unshift({ time: d.get('time'), detail: issue, nurse: state.auth.name });

          save();
          setMsg(document.getElementById('vitalsMsg'), 'ok', `Vitals/issue log saved for ${p.fullName}.`);
          vitalsForm.reset();
          renderContent();
        };
      }

      const medPatient = document.getElementById('medPatient');
      if (medPatient) {
        paintMedRows(medPatient.value);
        medPatient.onchange = () => paintMedRows(medPatient.value);
      }

      const medForm = document.getElementById('medForm');
      if (medForm) {
        medForm.onsubmit = (e) => {
          e.preventDefault();
          const d = new FormData(medForm);
          const p = state.patients.find(x => x.id === d.get('patientId'));
          if (!p) return;

          let count = 0;
          p.prescriptions.forEach((rx, i) => {
            if (d.get(`given_${i}`) === 'yes') {
              p.medLogs.unshift({
                medication: d.get(`med_${i}`),
                instruction: d.get(`ins_${i}`),
                scheduled: d.get(`sch_${i}`),
                givenAt: d.get(`time_${i}`) || new Date().toISOString(),
                nurse: state.auth.name
              });
              count++;
            }
          });
          save();
          setMsg(document.getElementById('medMsg'), 'ok', `${count} medication entries saved for ${p.fullName}.`);
          renderContent();
        };
      }
    }

    function bindPatient() {
      const ticketForm = document.getElementById('ticketForm');
      if (ticketForm) {
        ticketForm.onsubmit = (e) => {
          e.preventDefault();
          const d = new FormData(ticketForm);
          const p = state.patients.find(x => x.id === d.get('patientId'));
          const doctor = state.doctors.find(x => x.id === d.get('doctorId'));
          if (!p || !doctor) return;

          const t = {
            id: 't' + Date.now(),
            patientId: p.id,
            patient: p.fullName,
            ward: d.get('ward'),
            doctorId: doctor.id,
            doctor: doctor.name,
            category: d.get('category'),
            details: d.get('details'),
            status: 'open',
            createdAt: now()
          };
          state.tickets.unshift(t);
          queueEmail(doctor.email, 'Follow-up Ticket', `New post-discharge ticket from ${p.fullName}`);
          save();
          setMsg(document.getElementById('ticketMsg'), 'ok', `Ticket ${t.id} logged and sent to ${doctor.name}.`);
          ticketForm.reset();
        };
      }
    }

    function renderContent() {
      if (!state.auth.loggedIn) {
        contentEl.innerHTML = renderAuthLocked();
        return;
      }

      if (state.auth.role === 'admin') {
        if (activeTab === 'adminDashboard') contentEl.innerHTML = renderAdminDashboard();
        if (activeTab === 'openFile') contentEl.innerHTML = renderOpenFile();
        if (activeTab === 'assignCasualty') contentEl.innerHTML = renderAssignCasualty();
        if (activeTab === 'admissionsDesk') contentEl.innerHTML = renderAdmissionsDesk();
        if (activeTab === 'outbox') contentEl.innerHTML = renderOutbox();
        bindAdmin();
      }

      if (state.auth.role === 'doctor') {
        if (activeTab === 'doctorDashboard') contentEl.innerHTML = renderDoctorDashboard();
        if (activeTab === 'doctorAssessment') contentEl.innerHTML = renderDoctorAssessment();
        if (activeTab === 'doctorDecision') contentEl.innerHTML = renderDoctorDecision();
        if (activeTab === 'doctorDocs') contentEl.innerHTML = renderDoctorDocs();
        if (activeTab === 'outbox') contentEl.innerHTML = renderOutbox();
        bindDoctor();
      }

      if (state.auth.role === 'nurse') {
        if (activeTab === 'nurseDashboard') contentEl.innerHTML = renderNurseDashboard();
        if (activeTab === 'wardIntake') contentEl.innerHTML = renderWardIntake();
        if (activeTab === 'vitalsIssues') contentEl.innerHTML = renderVitalsIssues();
        if (activeTab === 'medAdmin') contentEl.innerHTML = renderMedAdmin();
        if (activeTab === 'outbox') contentEl.innerHTML = renderOutbox();
        bindNurse();
      }

      if (state.auth.role === 'patient') {
        if (activeTab === 'patientHome') contentEl.innerHTML = renderPatientHome();
        if (activeTab === 'patientTicket') contentEl.innerHTML = renderPatientTicket();
        bindPatient();
      }
    }

    function renderSession() {
      if (!state.auth.loggedIn) {
        sessionText.textContent = 'Not logged in';
        return;
      }
      sessionText.textContent = `${state.auth.name} (${state.auth.role}) | Last login: ${state.auth.lastLogin}`;
    }

    function render() {
      renderTabs();
      renderSession();
      renderContent();
    }

    document.getElementById('loginBtn').onclick = signIn;
    document.getElementById('logoutBtn').onclick = signOut;

    function tickClock() { document.getElementById('clock').textContent = `System time: ${new Date().toLocaleString()}`; }
    tickClock();
    setInterval(tickClock, 1000);

    render();
  </script>
</body>
</html>
