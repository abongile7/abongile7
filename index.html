<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Busamed Bloemfontein CareFlow Portal</title>
  <style>
    :root {
      --bg:#f4f7fc; --card:#fff; --line:#d6e2f5; --text:#1f2937; --muted:#667085;
      --primary:#1258c3; --primary2:#0f4698; --ok:#05603a; --okbg:#ecfdf3;
      --warn:#92400e; --warnbg:#fff7e8; --danger:#991b1b; --dangerbg:#fee2e2;
      --critical:#b91c1c; --high:#ea580c; --medium:#ca8a04; --low:#15803d;
    }
    *{box-sizing:border-box;font-family:Inter,Segoe UI,Arial,sans-serif}
    body{margin:0;background:var(--bg);color:var(--text)}
    header{background:linear-gradient(120deg,#0f3c83,#1258c3);color:#fff;padding:1rem 1.2rem;position:sticky;top:0;z-index:5}
    h1{margin:0;font-size:1.22rem} header p{margin:.3rem 0 0;opacity:.92}
    .topbar{display:flex;justify-content:space-between;gap:.8rem;align-items:center;flex-wrap:wrap}

    .container{max-width:1400px;margin:0 auto;padding:1rem;display:grid;gap:1rem}
    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:.92rem;box-shadow:0 4px 16px rgba(15,23,42,.06)}
    .row{display:flex;gap:.7rem;flex-wrap:wrap;align-items:center}
    .grid2{display:grid;gap:.9rem;grid-template-columns:repeat(auto-fit,minmax(320px,1fr))}
    .grid3{display:grid;gap:.8rem;grid-template-columns:repeat(auto-fit,minmax(240px,1fr))}
    .tabs{display:flex;gap:.5rem;flex-wrap:wrap}

    label{display:block;margin:.5rem 0 .22rem;font-size:.86rem;font-weight:600}
    input,select,textarea,button{width:100%;border:1px solid var(--line);border-radius:9px;padding:.55rem;font-size:.91rem}
    textarea{min-height:78px;resize:vertical}
    button{background:var(--primary);color:#fff;border:none;font-weight:700;cursor:pointer}
    button:hover{background:var(--primary2)}
    .btn-secondary{background:#eef4ff;color:#204d9c;border:1px solid #c4d6f8}
    .tabs button{width:auto;padding:.52rem .8rem}
    .tabs .active{background:var(--primary2)}

    .msg{display:none;border-radius:8px;padding:.48rem;margin-top:.6rem;font-size:.9rem}
    .ok{background:var(--okbg);color:var(--ok);border:1px solid #bde8cb}
    .warn{background:var(--warnbg);color:var(--warn);border:1px solid #f0d8b2}
    .danger{background:var(--dangerbg);color:var(--danger);border:1px solid #f2bcbc}
    .muted{color:var(--muted);font-size:.86rem}

    .badge{display:inline-block;border-radius:999px;padding:.16rem .52rem;color:#fff;font-size:.74rem;font-weight:700}
    .critical{background:var(--critical)} .high{background:var(--high)} .medium{background:var(--medium)} .low{background:var(--low)}

    table{width:100%;border-collapse:collapse;font-size:.88rem;margin-top:.35rem}
    th,td{text-align:left;border-bottom:1px solid var(--line);padding:.44rem;vertical-align:top}

    .kpis{display:grid;grid-template-columns:repeat(4,minmax(0,1fr));gap:.6rem}
    .kpi{background:#f8fbff;border:1px solid var(--line);border-radius:10px;padding:.58rem}
    .kpi small{display:block;color:var(--muted)} .kpi strong{color:#124cab;font-size:1.15rem}

    @media (max-width:900px){.kpis{grid-template-columns:1fr 1fr}}
  </style>
</head>
<body>
  <header>
    <div class="topbar">
      <div>
        <h1>Busamed Bloemfontein CareFlow Portal</h1>
        <p>Casualty to admission workflows, role-based access, user registration, and virtual follow-up.</p>
      </div>
      <div id="clock" style="font-size:.86rem;opacity:.95"></div>
    </div>
  </header>

  <main class="container">
    <section class="card" id="authCard"></section>
    <section class="card" id="tabsCard" style="display:none">
      <div class="tabs" id="tabs"></div>
    </section>
    <section id="content"></section>
  </main>

  <script>
    const KEY='busamed-careflow-v6';
    const defaultUsers=[
      {email:'admin@busamed.demo',password:'Admin@123',role:'admin',fullName:'N. Maseko',ward:'Admin',registeredAt:'2026-02-17 07:00'},
      {email:'doctor@busamed.demo',password:'Doctor@123',role:'doctor',fullName:'Dr. L. Mokoena',ward:'Casualty',registeredAt:'2026-02-17 07:00'},
      {email:'nurse@busamed.demo',password:'Nurse@123',role:'nurse',fullName:'P. Dube',ward:'Surgical',registeredAt:'2026-02-17 07:00'},
      {email:'patient@busamed.demo',password:'Patient@123',role:'patient',fullName:'T. Molefe',ward:'Surgical',registeredAt:'2026-02-17 07:00'}
    ];

    const tabsByRole={
      admin:[
        ['adminDash','Operations Dashboard'],['openFile','Open Patient File'],['assign','Assign Casualty Doctor'],['admitDischarge','Admit/Discharge'],['users','User Registration'],['outbox','Notification Outbox'],['audit','Audit Trail']
      ],
      doctor:[
        ['doctorDash','Casualty Queue'],['assessment','Assessment Form'],['decision','Disposition Form'],['docs','Clinical Docs']
      ],
      nurse:[
        ['nurseDash','Ward Dashboard'],['intake','Ward Intake'],['vitals','Vitals/Issues'],['meds','Medication Checklist'],['handover','Handover Notes']
      ],
      patient:[
        ['patientHome','My Summary'],['ticket','Post-discharge Ticket']
      ]
    };

    const seed={
      auth:{loggedIn:false,email:'',role:'',name:'',lastLogin:''},
      users:defaultUsers,
      doctors:[{id:'d1',name:'Dr. L. Mokoena',email:'doctor@busamed.demo',ward:'Casualty'},{id:'d2',name:'Dr. K. Naidoo',email:'dr.naidoo@busamed.demo',ward:'Medical'}],
      nurses:[{id:'n1',name:'Nurse P. Dube',email:'nurse@busamed.demo',ward:'Surgical'},{id:'n2',name:'Nurse A. Jacobs',email:'nurse.icu@busamed.demo',ward:'ICU'}],
      beds:{Surgical:24,ICU:12,Medical:20,Maternity:14,Casualty:18},
      patients:[{
        id:'p1',fullName:'Thabo Molefe',idNumber:'8501015009088',email:'patient@busamed.demo',phone:'0820001111',address:'12 Nelson Street, Bloemfontein',
        medicalAidScheme:'Discovery',medicalAidNumber:'DH8391022',nextOfKin:'Lerato Molefe',emergencyContact:'0829990000',
        presentingComplaint:'Chest discomfort and dizziness',triageCategory:'high',casualtyDoctorId:'d1',ward:'Surgical',status:'admitted',
        diagnosis:'Hypertension monitoring',assessments:[],prescriptions:[{id:'rx1',medication:'Amlodipine 5mg',instruction:'1 tablet after breakfast',schedule:'08:00',createdAt:'2026-02-17 09:20'}],
        docs:[],nurseIntake:null,vitals:[],issues:[],medLogs:[],handover:[],discharge:null
      }],
      tickets:[],emails:[{id:'e1',to:'doctor@busamed.demo',type:'Assignment',subject:'Assigned casualty patient: Thabo Molefe',sentAt:'2026-02-17 08:10'}],
      audit:[{id:'a1',time:'2026-02-17 08:10',actor:'System',action:'Demo seeded'}]
    };

    let state=load();
    let activeTab=state.auth.loggedIn?tabsByRole[state.auth.role][0][0]:'';

    const authCard=document.getElementById('authCard');
    const tabsCard=document.getElementById('tabsCard');
    const tabsEl=document.getElementById('tabs');
    const contentEl=document.getElementById('content');

    function now(){return new Date().toLocaleString();}
    function load(){try{const r=localStorage.getItem(KEY);return r?JSON.parse(r):structuredClone(seed);}catch{return structuredClone(seed);}}
    function save(){localStorage.setItem(KEY,JSON.stringify(state));}
    function badge(level){return `<span class="badge ${level||'low'}">${(level||'low').toUpperCase()}</span>`;}
    function doctorName(id){return state.doctors.find(d=>d.id===id)?.name||'Unassigned';}
    function patientOptions(filter){const l=filter?state.patients.filter(filter):state.patients;return l.map(p=>`<option value="${p.id}">${p.fullName} - ${p.status} - ${p.ward||'-'}</option>`).join('');}
    function msg(el,kind,text){el.className=`msg ${kind}`;el.style.display='block';el.textContent=text;}
    function audit(action){state.audit.unshift({id:'a'+Date.now(),time:now(),actor:state.auth.name||'System',action});}
    function queueEmail(to,type,subject){state.emails.unshift({id:'e'+Date.now(),to,type,subject,sentAt:now()});}

    function renderAuth(){
      authCard.innerHTML=`
        <div class="grid2">
          <div>
            <h2 style="margin:0 0 .5rem">Secure Login (Demo)</h2>
            <p class="muted">Admin: admin@busamed.demo / Admin@123 | Doctor: doctor@busamed.demo / Doctor@123 | Nurse: nurse@busamed.demo / Nurse@123 | Patient: patient@busamed.demo / Patient@123 | OTP: 123456</p>
            <label>Email</label><input id="email" type="email" placeholder="user@busamed.demo" />
            <label>Password</label><input id="password" type="password" />
            <label>One-time Code</label><input id="otp" placeholder="123456" />
            <div class="row" style="margin-top:.55rem"><button id="loginBtn">Login</button><button id="logoutBtn" class="btn-secondary">Logout</button></div>
            <div id="authMsg" class="msg"></div>
          </div>
          <div>
            <h2 style="margin:0 0 .5rem">Session & Modern Enhancements</h2>
            <ul class="muted" style="margin:0;padding-left:1rem;line-height:1.5">
              <li>Role-based access tabs at the top for faster workflow switching.</li>
              <li>User registration and role assignment managed in-app.</li>
              <li>Bed occupancy visibility for Surgical/ICU/Medical/Maternity/Casualty.</li>
              <li>Audit trail for governance and accountability.</li>
              <li>Optimized for tablets/laptops for bedside and remote use.</li>
            </ul>
            <p class="muted" style="margin-top:.7rem"><strong>Session:</strong> ${state.auth.loggedIn?`${state.auth.name} (${state.auth.role}) | ${state.auth.lastLogin}`:'Not logged in'}</p>
          </div>
        </div>`;

      document.getElementById('loginBtn').onclick=handleLogin;
      document.getElementById('logoutBtn').onclick=handleLogout;
    }

    function handleLogin(){
      const email=document.getElementById('email').value.trim().toLowerCase();
      const password=document.getElementById('password').value;
      const otp=document.getElementById('otp').value.trim();
      const u=state.users.find(x=>x.email===email);
      const m=document.getElementById('authMsg');
      if(!u||u.password!==password||otp!=='123456'){msg(m,'danger','Login failed. Check credentials and OTP 123456.');return;}
      state.auth={loggedIn:true,email:u.email,role:u.role,name:u.fullName,lastLogin:now()};
      activeTab=tabsByRole[u.role][0][0];
      audit(`Logged in as ${u.role}`);
      save();
      msg(m,'ok',`Welcome ${u.fullName}.`);
      render();
    }

    function handleLogout(){
      state.auth={loggedIn:false,email:'',role:'',name:'',lastLogin:''};
      activeTab='';
      audit('Logged out');
      save();
      render();
    }

    function renderTabs(){
      tabsEl.innerHTML='';
      if(!state.auth.loggedIn){tabsCard.style.display='none';return;}
      tabsCard.style.display='block';
      tabsByRole[state.auth.role].forEach(([id,label])=>{
        const b=document.createElement('button');
        b.textContent=label;
        b.className=activeTab===id?'active':'btn-secondary';
        b.onclick=()=>{activeTab=id;renderTabs();renderContent();};
        tabsEl.appendChild(b);
      });
    }

    function adminDashboard(){
      const admitted=state.patients.filter(p=>p.status==='admitted').length;
      const discharged=state.patients.filter(p=>p.status==='discharged').length;
      const occupancy=Object.entries(state.beds).map(([ward,total])=>{
        const used=state.patients.filter(p=>p.status==='admitted'&&p.ward===ward).length;
        return `<tr><td>${ward}</td><td>${used}/${total}</td><td>${Math.round((used/total)*100)}%</td></tr>`;
      }).join('');
      return `<div class="card"><h2>Operations Dashboard</h2>
        <div class="kpis"><div class="kpi"><small>Patient Files</small><strong>${state.patients.length}</strong></div><div class="kpi"><small>Admitted</small><strong>${admitted}</strong></div><div class="kpi"><small>Discharged</small><strong>${discharged}</strong></div><div class="kpi"><small>Notifications</small><strong>${state.emails.length}</strong></div></div>
      </div>
      <div class="grid2"><div class="card"><h3>Casualty/Admission Board</h3><table><thead><tr><th>Patient</th><th>Triage</th><th>Status</th><th>Doctor</th><th>Ward</th></tr></thead><tbody>${state.patients.map(p=>`<tr><td>${p.fullName}</td><td>${badge(p.triageCategory)}</td><td>${p.status}</td><td>${doctorName(p.casualtyDoctorId)}</td><td>${p.ward||'-'}</td></tr>`).join('')}</tbody></table></div>
      <div class="card"><h3>Ward Bed Occupancy</h3><table><thead><tr><th>Ward</th><th>Beds Used</th><th>Occupancy</th></tr></thead><tbody>${occupancy}</tbody></table></div></div>`;
    }

    function openFileView(){return `<div class="card"><h2>Open Patient File (SA Hospital Casualty)</h2><form id="openForm"><div class="grid2"><div>
      <label>Full Name</label><input required name="fullName"/><label>ID Number</label><input required name="idNumber"/><label>Email</label><input required type="email" name="email"/><label>Phone</label><input required name="phone"/><label>Home Address</label><textarea required name="address"></textarea><label>Emergency Contact</label><input required name="emergencyContact"/>
      </div><div><label>Medical Aid Scheme</label><input required name="medicalAidScheme"/><label>Medical Aid Number</label><input required name="medicalAidNumber"/><label>Next of Kin</label><input required name="nextOfKin"/><label>Presenting Complaint</label><textarea required name="presentingComplaint"></textarea><label>Triage</label><select required name="triageCategory"><option value="low">Low</option><option value="medium">Medium</option><option value="high">High</option><option value="critical">Critical</option></select><label>Consent Signature</label><input required name="signature"/></div></div>
      <button type="submit">Open File</button><div id="openMsg" class="msg ok"></div></form></div>`;}

    function assignView(){return `<div class="card"><h2>Assign Casualty Doctor</h2><form id="assignForm"><label>Patient</label><select required name="patientId">${patientOptions(p=>p.status!=='discharged')}</select><label>Doctor</label><select required name="doctorId">${state.doctors.map(d=>`<option value="${d.id}">${d.name} (${d.email})</option>`).join('')}</select><button type="submit">Assign + Notify</button><div id="assignMsg" class="msg ok"></div></form></div>`;}

    function admitDischargeView(){const admitted=state.patients.filter(p=>p.status==='admitted');return `<div class="card"><h2>Admit / Discharge Desk</h2><form id="dischargeForm"><label>Discharge Patient</label><select required name="patientId">${admitted.length?patientOptions(p=>p.status==='admitted'):'<option value="">No admitted patients</option>'}</select><label>Discharge Summary</label><textarea required name="summary"></textarea><label>Rating</label><select required name="rating"><option>5</option><option>4</option><option>3</option><option>2</option><option>1</option></select><label>Feedback</label><textarea required name="feedback"></textarea><button type="submit">Discharge Patient</button><div id="dischargeMsg" class="msg ok"></div></form></div>`;}

    function userManagementView(){return `<div class="grid2"><div class="card"><h2>User Registration & Role Assignment</h2><form id="userForm"><label>Full Name</label><input required name="fullName"/><label>Email</label><input required type="email" name="email"/><label>Password</label><input required name="password"/><label>Role</label><select required name="role"><option value="admin">Admin</option><option value="doctor">Doctor</option><option value="nurse">Nurse</option><option value="patient">Patient</option></select><label>Ward/Department</label><select required name="ward"><option>Admin</option><option>Casualty</option><option>Surgical</option><option>ICU</option><option>Medical</option><option>Maternity</option></select><button type="submit">Register User</button><div id="userMsg" class="msg ok"></div></form></div>
      <div class="card"><h3>Registered Users</h3><table><thead><tr><th>Name</th><th>Email</th><th>Role</th><th>Ward</th><th>Registered</th></tr></thead><tbody>${state.users.map(u=>`<tr><td>${u.fullName}</td><td>${u.email}</td><td>${u.role}</td><td>${u.ward}</td><td>${u.registeredAt}</td></tr>`).join('')}</tbody></table></div></div>`;}

    function doctorDashboard(){return `<div class="card"><h2>Casualty Queue</h2><table><thead><tr><th>Patient</th><th>Triage</th><th>Complaint</th><th>Status</th></tr></thead><tbody>${state.patients.filter(p=>p.status!=='discharged').map(p=>`<tr><td>${p.fullName}</td><td>${badge(p.triageCategory)}</td><td>${p.presentingComplaint}</td><td>${p.status}</td></tr>`).join('')}</tbody></table></div>`;}
    function assessmentView(){return `<div class="card"><h2>Casualty Assessment Form</h2><form id="assessmentForm"><label>Patient</label><select required name="patientId">${patientOptions(p=>p.status!=='discharged')}</select><label>Assessment Date/Time</label><input required type="datetime-local" name="time"/><label>Clinical Notes</label><textarea required name="notes"></textarea><label>Diagnosis</label><textarea required name="diagnosis"></textarea><label>Criticality Update</label><select required name="triageCategory"><option value="low">Low</option><option value="medium">Medium</option><option value="high">High</option><option value="critical">Critical</option></select><button type="submit">Save Assessment</button><div id="assessmentMsg" class="msg ok"></div></form></div>`;}
    function decisionView(){return `<div class="card"><h2>Disposition Form</h2><form id="decisionForm"><label>Patient</label><select required name="patientId">${patientOptions(p=>p.status!=='discharged')}</select><label>Decision</label><select required name="decision"><option value="home">Treat and Send Home</option><option value="admit">Admit to Ward</option></select><label>Medication</label><input required name="medication"/><label>Instruction</label><textarea required name="instruction"></textarea><label>Schedule Time</label><input required type="time" name="schedule"/><label>Ward if admitted</label><select name="ward"><option>Surgical</option><option>ICU</option><option>Medical</option><option>Maternity</option></select><button type="submit">Save Decision + Notify</button><div id="decisionMsg" class="msg ok"></div></form></div>`;}
    function docsView(){return `<div class="card"><h2>Clinical Document Upload (PDF max 10)</h2><form id="docForm"><label>Patient</label><select required name="patientId">${patientOptions(p=>p.status!=='discharged')}</select><label>Title</label><input required name="title"/><label>Upload PDF</label><input required type="file" name="file" accept="application/pdf,.pdf"/><button type="submit">Upload</button><div id="docMsg" class="msg"></div></form></div>`;}

    function nurseDashboard(){return `<div class="card"><h2>Ward Dashboard</h2><table><thead><tr><th>Patient</th><th>Ward</th><th>Triage</th><th>Vitals</th><th>Issues</th><th>Meds</th></tr></thead><tbody>${state.patients.filter(p=>p.status==='admitted').map(p=>`<tr><td>${p.fullName}</td><td>${p.ward}</td><td>${badge(p.triageCategory)}</td><td>${p.vitals.length}</td><td>${p.issues.length}</td><td>${p.medLogs.length}</td></tr>`).join('')}</tbody></table></div>`;}
    function intakeView(){return `<div class="card"><h2>Ward Intake Form</h2><form id="intakeForm"><label>Patient</label><select required name="patientId">${patientOptions(p=>p.status==='admitted')}</select><label>Date/Time</label><input required type="datetime-local" name="time"/><label>Observations</label><textarea required name="observations"></textarea><label>Care Plan</label><textarea required name="carePlan"></textarea><button type="submit">Save Intake</button><div id="intakeMsg" class="msg ok"></div></form></div>`;}
    function vitalsView(){return `<div class="card"><h2>Vitals and Issues</h2><form id="vitalsForm"><label>Patient</label><select required name="patientId">${patientOptions(p=>p.status==='admitted')}</select><label>Date/Time</label><input required type="datetime-local" name="time"/><label>Blood Pressure</label><input required name="bp"/><label>Pulse/Temp/Notes</label><textarea required name="notes"></textarea><label>Issue (optional)</label><textarea name="issue"></textarea><button type="submit">Save Log</button><div id="vitalsMsg" class="msg ok"></div></form></div>`;}
    function medsView(){return `<div class="card"><h2>Medication Checklist</h2><form id="medForm"><label>Patient</label><select required id="medPatient" name="patientId">${patientOptions(p=>p.status==='admitted')}</select><div id="medRows" class="grid3" style="margin-top:.6rem"></div><button type="submit">Save Medication Tick</button><div id="medMsg" class="msg ok"></div></form></div>`;}
    function handoverView(){return `<div class="card"><h2>Nurse Handover Notes</h2><form id="handoverForm"><label>Patient</label><select required name="patientId">${patientOptions(p=>p.status==='admitted')}</select><label>Shift</label><select required name="shift"><option>Day Shift</option><option>Night Shift</option></select><label>Handover Notes</label><textarea required name="notes"></textarea><button type="submit">Save Handover</button><div id="handoverMsg" class="msg ok"></div></form></div>`;}

    function patientHome(){const p=state.patients.find(x=>x.email===state.auth.email)||state.patients[0];return `<div class="card"><h2>My Discharge Summary</h2><p><strong>Name:</strong> ${p.fullName}</p><p><strong>Status:</strong> ${p.status}</p><p><strong>Doctor:</strong> ${doctorName(p.casualtyDoctorId)}</p><p><strong>Summary:</strong> ${p.discharge?.summary||'Not discharged yet'}</p></div>`;}
    function patientTicket(){const dis=state.patients.filter(p=>p.status==='discharged');return `<div class="card"><h2>Post-discharge Ticket</h2><form id="ticketForm"><label>Patient</label><select required name="patientId">${dis.length?patientOptions(p=>p.status==='discharged'):'<option value="">No discharged patients</option>'}</select><label>Ward</label><input required name="ward"/><label>Doctor</label><select required name="doctorId">${state.doctors.map(d=>`<option value="${d.id}">${d.name}</option>`).join('')}</select><label>Category</label><select required name="category"><option>Medication Query</option><option>Wound Concern</option><option>Pain Management</option><option>Billing/Admin</option></select><label>Details</label><textarea required name="details"></textarea><button type="submit">Create Ticket</button><div id="ticketMsg" class="msg ok"></div></form></div>`;}

    function outboxView(){return `<div class="card"><h2>Notification Outbox</h2><table><thead><tr><th>Time</th><th>To</th><th>Type</th><th>Subject</th></tr></thead><tbody>${state.emails.length?state.emails.map(e=>`<tr><td>${e.sentAt}</td><td>${e.to}</td><td>${e.type}</td><td>${e.subject}</td></tr>`).join(''):'<tr><td colspan="4">No notifications</td></tr>'}</tbody></table></div>`;}
    function auditView(){return `<div class="card"><h2>Audit Trail</h2><table><thead><tr><th>Time</th><th>Actor</th><th>Action</th></tr></thead><tbody>${state.audit.map(a=>`<tr><td>${a.time}</td><td>${a.actor}</td><td>${a.action}</td></tr>`).join('')}</tbody></table></div>`;}

    function paintMedRows(pid){const holder=document.getElementById('medRows');const p=state.patients.find(x=>x.id===pid);if(!holder||!p)return;if(!p.prescriptions.length){holder.innerHTML='<p class="muted">No prescriptions for this patient.</p>';return;}holder.innerHTML=p.prescriptions.map((rx,i)=>`<div class="card"><strong>${rx.medication}</strong> ${badge(p.triageCategory)}<p class="muted">Time: ${rx.schedule} | ${rx.instruction}</p><label>Given?</label><select name="given_${i}"><option value="yes">Yes</option><option value="no">No</option></select><label>Given at</label><input type="datetime-local" name="time_${i}"/><input type="hidden" name="med_${i}" value="${rx.medication}"/><input type="hidden" name="ins_${i}" value="${rx.instruction}"/><input type="hidden" name="sch_${i}" value="${rx.schedule}"/></div>`).join('');}

    function bindHandlers(){
      if(document.getElementById('openForm')) document.getElementById('openForm').onsubmit=(e)=>{e.preventDefault();const d=new FormData(e.target);const p={id:'p'+Date.now(),fullName:d.get('fullName'),idNumber:d.get('idNumber'),email:d.get('email'),phone:d.get('phone'),address:d.get('address'),medicalAidScheme:d.get('medicalAidScheme'),medicalAidNumber:d.get('medicalAidNumber'),nextOfKin:d.get('nextOfKin'),emergencyContact:d.get('emergencyContact'),presentingComplaint:d.get('presentingComplaint'),triageCategory:d.get('triageCategory'),casualtyDoctorId:'',ward:'Casualty',status:'casualty',diagnosis:'',assessments:[],prescriptions:[],docs:[],nurseIntake:null,vitals:[],issues:[],medLogs:[],handover:[],discharge:null};state.patients.push(p);audit(`Opened file for ${p.fullName}`);save();msg(document.getElementById('openMsg'),'ok',`${p.fullName} file opened.`);e.target.reset();renderContent();};

      if(document.getElementById('assignForm')) document.getElementById('assignForm').onsubmit=(e)=>{e.preventDefault();const d=new FormData(e.target);const p=state.patients.find(x=>x.id===d.get('patientId'));const doc=state.doctors.find(x=>x.id===d.get('doctorId'));if(!p||!doc)return;p.casualtyDoctorId=doc.id;queueEmail(doc.email,'Doctor Assignment',`Assigned casualty case: ${p.fullName}`);audit(`Assigned ${doc.name} to ${p.fullName}`);save();msg(document.getElementById('assignMsg'),'ok',`${doc.name} assigned and notified.`);};

      if(document.getElementById('dischargeForm')) document.getElementById('dischargeForm').onsubmit=(e)=>{e.preventDefault();const d=new FormData(e.target);const p=state.patients.find(x=>x.id===d.get('patientId'));if(!p)return;p.status='discharged';p.discharge={time:now(),summary:d.get('summary'),rating:Number(d.get('rating')),feedback:d.get('feedback')};queueEmail(p.email,'Discharge',`Discharged from Busamed. Rating ${p.discharge.rating}/5`);audit(`Discharged ${p.fullName}`);save();msg(document.getElementById('dischargeMsg'),'ok',`${p.fullName} discharged.`);renderContent();};

      if(document.getElementById('userForm')) document.getElementById('userForm').onsubmit=(e)=>{e.preventDefault();const d=new FormData(e.target);const email=(d.get('email')||'').toLowerCase();if(state.users.some(u=>u.email===email)){msg(document.getElementById('userMsg'),'warn','Email already registered.');return;}const u={fullName:d.get('fullName'),email,password:d.get('password'),role:d.get('role'),ward:d.get('ward'),registeredAt:now()};state.users.push(u);if(u.role==='doctor') state.doctors.push({id:'d'+Date.now(),name:u.fullName,email:u.email,ward:u.ward});if(u.role==='nurse') state.nurses.push({id:'n'+Date.now(),name:u.fullName,email:u.email,ward:u.ward});audit(`Registered user ${u.email} (${u.role})`);save();msg(document.getElementById('userMsg'),'ok',`User ${u.email} registered.`);e.target.reset();renderContent();};

      if(document.getElementById('assessmentForm')) document.getElementById('assessmentForm').onsubmit=(e)=>{e.preventDefault();const d=new FormData(e.target);const p=state.patients.find(x=>x.id===d.get('patientId'));if(!p)return;p.assessments.unshift({time:d.get('time'),notes:d.get('notes'),diagnosis:d.get('diagnosis'),doctor:state.auth.name});p.diagnosis=d.get('diagnosis');p.triageCategory=d.get('triageCategory');audit(`Assessment saved for ${p.fullName}`);save();msg(document.getElementById('assessmentMsg'),'ok',`Assessment saved.`);e.target.reset();renderContent();};

      if(document.getElementById('decisionForm')) document.getElementById('decisionForm').onsubmit=(e)=>{e.preventDefault();const d=new FormData(e.target);const p=state.patients.find(x=>x.id===d.get('patientId'));if(!p)return;p.prescriptions.unshift({id:'rx'+Date.now(),medication:d.get('medication'),instruction:d.get('instruction'),schedule:d.get('schedule'),createdAt:now()});if(d.get('decision')==='home'){p.status='discharged';p.ward='Home';p.discharge={time:now(),summary:'Casualty treatment completed, discharged with medication.'};queueEmail(p.email,'Casualty Outcome','Treated and sent home with medication');}else{p.status='admitted';p.ward=d.get('ward');state.nurses.filter(n=>n.ward.toLowerCase()===p.ward.toLowerCase()).forEach(n=>queueEmail(n.email,'Ward Admission',`New admission: ${p.fullName} (${p.ward})`));const doc=state.doctors.find(x=>x.id===p.casualtyDoctorId);if(doc) queueEmail(doc.email,'Admission File',`Patient admitted: ${p.fullName}`);}audit(`Disposition set for ${p.fullName}: ${d.get('decision')}`);save();msg(document.getElementById('decisionMsg'),'ok','Decision saved and notifications sent.');e.target.reset();renderContent();};

      if(document.getElementById('docForm')) document.getElementById('docForm').onsubmit=(e)=>{e.preventDefault();const d=new FormData(e.target);const p=state.patients.find(x=>x.id===d.get('patientId'));const f=d.get('file');const m=document.getElementById('docMsg');if(!p)return;if(p.docs.length>=10){msg(m,'warn','Max 10 docs reached.');return;}if(!f||!f.name||!f.name.toLowerCase().endsWith('.pdf')){msg(m,'warn','Only PDF allowed.');return;}p.docs.unshift({title:d.get('title'),fileName:f.name,uploadedAt:now(),uploadedBy:state.auth.name});audit(`Uploaded doc for ${p.fullName}`);save();msg(m,'ok',`File uploaded (${p.docs.length}/10).`);e.target.reset();};

      if(document.getElementById('intakeForm')) document.getElementById('intakeForm').onsubmit=(e)=>{e.preventDefault();const d=new FormData(e.target);const p=state.patients.find(x=>x.id===d.get('patientId'));if(!p)return;p.nurseIntake={time:d.get('time'),observations:d.get('observations'),carePlan:d.get('carePlan'),nurse:state.auth.name};audit(`Ward intake saved for ${p.fullName}`);save();msg(document.getElementById('intakeMsg'),'ok','Intake saved.');e.target.reset();};

      if(document.getElementById('vitalsForm')) document.getElementById('vitalsForm').onsubmit=(e)=>{e.preventDefault();const d=new FormData(e.target);const p=state.patients.find(x=>x.id===d.get('patientId'));if(!p)return;p.vitals.unshift({time:d.get('time'),bloodPressure:d.get('bp'),notes:d.get('notes'),nurse:state.auth.name});if((d.get('issue')||'').trim()) p.issues.unshift({time:d.get('time'),detail:d.get('issue'),nurse:state.auth.name});audit(`Vitals logged for ${p.fullName}`);save();msg(document.getElementById('vitalsMsg'),'ok','Vitals/issues saved.');e.target.reset();renderContent();};

      const medPatient=document.getElementById('medPatient');
      if(medPatient){paintMedRows(medPatient.value);medPatient.onchange=()=>paintMedRows(medPatient.value);}      
      if(document.getElementById('medForm')) document.getElementById('medForm').onsubmit=(e)=>{e.preventDefault();const d=new FormData(e.target);const p=state.patients.find(x=>x.id===d.get('patientId'));if(!p)return;let c=0;p.prescriptions.forEach((_,i)=>{if(d.get(`given_${i}`)==='yes'){p.medLogs.unshift({medication:d.get(`med_${i}`),instruction:d.get(`ins_${i}`),scheduled:d.get(`sch_${i}`),givenAt:d.get(`time_${i}`)||new Date().toISOString(),nurse:state.auth.name});c++;}});audit(`Medication logs saved for ${p.fullName} (${c})`);save();msg(document.getElementById('medMsg'),'ok',`${c} medication entries saved.`);renderContent();};

      if(document.getElementById('handoverForm')) document.getElementById('handoverForm').onsubmit=(e)=>{e.preventDefault();const d=new FormData(e.target);const p=state.patients.find(x=>x.id===d.get('patientId'));if(!p)return;p.handover.unshift({shift:d.get('shift'),notes:d.get('notes'),nurse:state.auth.name,time:now()});audit(`Handover note saved for ${p.fullName}`);save();msg(document.getElementById('handoverMsg'),'ok','Handover saved.');e.target.reset();};

      if(document.getElementById('ticketForm')) document.getElementById('ticketForm').onsubmit=(e)=>{e.preventDefault();const d=new FormData(e.target);const p=state.patients.find(x=>x.id===d.get('patientId'));const doc=state.doctors.find(x=>x.id===d.get('doctorId'));if(!p||!doc)return;const t={id:'t'+Date.now(),patient:p.fullName,patientId:p.id,ward:d.get('ward'),doctor:doc.name,doctorId:doc.id,category:d.get('category'),details:d.get('details'),status:'open',createdAt:now()};state.tickets.unshift(t);queueEmail(doc.email,'Follow-up Ticket',`New post-discharge ticket from ${p.fullName}`);audit(`Ticket created ${t.id}`);save();msg(document.getElementById('ticketMsg'),'ok',`Ticket ${t.id} created.`);e.target.reset();};
    }

    function renderContent(){
      if(!state.auth.loggedIn){contentEl.innerHTML='<section class="card"><h2>Please login</h2><p class="muted">Use credentials above to access role-based tabs.</p></section>';return;}
      if(state.auth.role==='admin'){
        if(activeTab==='adminDash') contentEl.innerHTML=adminDashboard();
        if(activeTab==='openFile') contentEl.innerHTML=openFileView();
        if(activeTab==='assign') contentEl.innerHTML=assignView();
        if(activeTab==='admitDischarge') contentEl.innerHTML=admitDischargeView();
        if(activeTab==='users') contentEl.innerHTML=userManagementView();
        if(activeTab==='outbox') contentEl.innerHTML=outboxView();
        if(activeTab==='audit') contentEl.innerHTML=auditView();
      }
      if(state.auth.role==='doctor'){
        if(activeTab==='doctorDash') contentEl.innerHTML=doctorDashboard();
        if(activeTab==='assessment') contentEl.innerHTML=assessmentView();
        if(activeTab==='decision') contentEl.innerHTML=decisionView();
        if(activeTab==='docs') contentEl.innerHTML=docsView();
      }
      if(state.auth.role==='nurse'){
        if(activeTab==='nurseDash') contentEl.innerHTML=nurseDashboard();
        if(activeTab==='intake') contentEl.innerHTML=intakeView();
        if(activeTab==='vitals') contentEl.innerHTML=vitalsView();
        if(activeTab==='meds') contentEl.innerHTML=medsView();
        if(activeTab==='handover') contentEl.innerHTML=handoverView();
      }
      if(state.auth.role==='patient'){
        if(activeTab==='patientHome') contentEl.innerHTML=patientHome();
        if(activeTab==='ticket') contentEl.innerHTML=patientTicket();
      }
      bindHandlers();
    }

    function render(){renderAuth();renderTabs();renderContent();save();}
    function tick(){document.getElementById('clock').textContent='System time: '+new Date().toLocaleString();}
    tick(); setInterval(tick,1000);
    render();
  </script>
</body>
</html>
